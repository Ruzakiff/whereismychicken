<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>How Long for Chicken?</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        .container {
            text-align: center;
            position: relative;
            top: -15vh;
        }
        h1 {
            font-size: 2.5em;
            margin-bottom: 1em;
        }
        .time {
            font-size: 4em;
            font-weight: bold;
            color: #4a4a4a;
        }
        .eastern-time {
            font-size: 1.5em;
            color: #666;
            margin-top: 0.5em;
        }
        .btn {
            margin-top: 1em;
            padding: 0.5em 1em;
            font-size: 1em;
            cursor: pointer;
        }
        #actualTimeInput {
            display: none;
            margin-top: 1em;
        }
        .schedule-container {
            margin-top: 2em;
            width: 90%;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .schedule-table th,
        .schedule-table td {
            padding: 12px 8px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        .schedule-table th {
            background: #4a4a4a;
            color: white;
            font-size: 0.9em;
        }

        .schedule-table td {
            font-size: 1.1em;
        }

        .schedule-table tr:last-child td {
            border-bottom: none;
        }

        .current-batch {
            background-color: #f0f8ff;
            font-weight: bold;
        }

        @media (max-width: 380px) {
            .schedule-table th,
            .schedule-table td {
                padding: 8px 4px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>How Long for Chicken?</h1>
        <div class="time" id="countdown"></div>
        <div class="eastern-time" id="eastern-time"></div>
        <button class="btn" onclick="showOvenDetails()">See Oven Details</button>
        <div class="schedule-container">
            <table class="schedule-table">
                <thead>
                    <tr>
                        <th>Oven</th>
                        <th>Target Time</th>
                    </tr>
                </thead>
                <tbody id="scheduleBody">
                    <!-- Will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let targetTime = null;

        function showOvenDetails() {
            window.location.href = '/ovens';
        }

        function updateCountdown() {
            if (!targetTime) {
                fetchPrediction();
                return;
            }

            const now = new Date();
            const timeDiff = targetTime - now;

            if (timeDiff <= 0) {
                fetchPrediction();
                return;
            }

            const hours = Math.floor(timeDiff / 3600000);
            const minutes = Math.floor((timeDiff % 3600000) / 60000);
            const seconds = Math.floor((timeDiff % 60000) / 1000);

            if (hours > 0) {
                document.getElementById('countdown').textContent = `${hours}h ${minutes}m`;
            } else {
                document.getElementById('countdown').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        function updateSchedule(data) {
            const scheduleBody = document.getElementById('schedule-body');
            scheduleBody.innerHTML = '';

            if (!data || !data.batches || data.batches.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="3">No active batches</td>';
                scheduleBody.appendChild(row);
                return;
            }

            data.batches.forEach(batch => {
                const row = document.createElement('tr');
                const startTime = new Date(batch.start_time);
                const readyTime = new Date(batch.ready_time);
                
                // Format times in 12-hour format
                const formatTime = (date) => {
                    return date.toLocaleTimeString('en-US', {
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    }).toLowerCase();
                };

                // Add 'current-batch' class if this is the next ready batch
                if (batch.is_next) {
                    row.classList.add('current-batch');
                }

                row.innerHTML = `
                    <td>${batch.number}</td>
                    <td>${formatTime(startTime)}</td>
                    <td>${formatTime(readyTime)}</td>
                `;
                scheduleBody.appendChild(row);
            });
        }

        function fetchPrediction() {
            fetch('/predict')
                .then(response => response.json())
                .then(data => {
                    if (data.earliest_time) {
                        targetTime = new Date(data.earliest_time);
                        const now = new Date();
                        if (targetTime.getDate() !== now.getDate()) {
                            document.getElementById('countdown').textContent = "Next batch tomorrow";
                        } else if (!data.is_open) {
                            document.getElementById('countdown').textContent = "Store closed";
                        } else {
                            document.getElementById('eastern-time').textContent = targetTime.toLocaleTimeString('en-US', { timeZone: 'America/New_York' });
                            updateCountdown();
                        }
                    } else {
                        document.getElementById('countdown').textContent = "No prediction available";
                        document.getElementById('eastern-time').textContent = "";
                        targetTime = null;
                    }

                    // Update schedule
                    updateSchedule(data);
                });
        }

        // Initial fetch
        fetchPrediction();

        // Update countdown every second
        setInterval(updateCountdown, 1000);

        // Fetch new prediction every minute
        setInterval(fetchPrediction, 60000);

        // Add this with your other JavaScript
        const evtSource = new EventSource("/events");
        
        evtSource.onopen = function(event) {
            console.log('SSE connection opened');
        };
        
        evtSource.onerror = function(event) {
            console.log('SSE connection error:', event);
        };
        
        evtSource.onmessage = function(event) {
            console.log('SSE message received:', event.data);
            if (event.data === "update") {
                // Force immediate update
                fetchPrediction();
                // Reset the interval timer to avoid quick double updates
                clearInterval(updateInterval);
                updateInterval = setInterval(fetchPrediction, 60000);
            }
        };

        // Store interval ID so we can reset it
        let updateInterval = setInterval(fetchPrediction, 60000);

        // Initial update
        fetchPrediction();

        // Add this to your existing JavaScript
        function loadSchedule() {
            fetch('/schedule')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const scheduleBody = document.getElementById('scheduleBody');
                    scheduleBody.innerHTML = '';
                    
                    if (!data.schedule || data.schedule.length === 0) {
                        scheduleBody.innerHTML = '<tr><td colspan="2">Schedule not available</td></tr>';
                        return;
                    }
                    
                    data.schedule.forEach(([oven, time]) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `<td>${oven}</td><td>${time}</td>`;
                        scheduleBody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error loading schedule:', error);
                    document.getElementById('scheduleBody').innerHTML = 
                        '<tr><td colspan="2">Unable to load schedule</td></tr>';
                });
        }

        // Load schedule when page loads
        document.addEventListener('DOMContentLoaded', loadSchedule);
    </script>
</body>
</html>

