<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>How Long for Chicken?</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        .container {
            text-align: center;
            position: relative;
            top: -15vh;
        }
        h1 {
            font-size: 2.5em;
            margin-bottom: 1em;
        }
        .time {
            font-size: 4em;
            font-weight: bold;
            color: #4a4a4a;
        }
        .eastern-time {
            font-size: 1.5em;
            color: #666;
            margin-top: 0.5em;
        }
        .btn {
            margin-top: 1em;
            padding: 0.5em 1em;
            font-size: 1em;
            cursor: pointer;
        }
        #actualTimeInput {
            display: none;
            margin-top: 1em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>How Long for Chicken?</h1>
        <div class="time" id="countdown"></div>
        <div class="eastern-time" id="eastern-time"></div>
        <button class="btn" onclick="showOvenDetails()">See Oven Details</button>
    </div>

    <script>
        let targetTime = null;

        function showOvenDetails() {
            window.location.href = '/ovens';
        }

        function updateCountdown() {
            if (!targetTime) {
                fetchPrediction();
                return;
            }

            const now = new Date();
            const timeDiff = targetTime - now;

            if (timeDiff <= 0) {
                fetchPrediction();
                return;
            }

            const hours = Math.floor(timeDiff / 3600000);
            const minutes = Math.floor((timeDiff % 3600000) / 60000);
            const seconds = Math.floor((timeDiff % 60000) / 1000);

            if (hours > 0) {
                document.getElementById('countdown').textContent = `${hours}h ${minutes}m`;
            } else {
                document.getElementById('countdown').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        function fetchPrediction() {
            fetch('/predict')
                .then(response => response.json())
                .then(data => {
                    if (data.earliest_time) {
                        targetTime = new Date(data.earliest_time);
                        const now = new Date();
                        if (targetTime.getDate() !== now.getDate()) {
                            document.getElementById('countdown').textContent = "Next batch tomorrow";
                        } else if (!data.is_open) {
                            document.getElementById('countdown').textContent = "Store closed";
                        } else {
                            document.getElementById('eastern-time').textContent = targetTime.toLocaleTimeString('en-US', { timeZone: 'America/New_York' });
                            updateCountdown();
                        }
                    } else {
                        document.getElementById('countdown').textContent = "No prediction available";
                        document.getElementById('eastern-time').textContent = "";
                        targetTime = null;
                    }
                });
        }

        // Initial fetch
        fetchPrediction();

        // Update countdown every second
        setInterval(updateCountdown, 1000);

        // Fetch new prediction every minute
        setInterval(fetchPrediction, 60000);

        // Add this with your other JavaScript
        const evtSource = new EventSource("/events");
        
        evtSource.onopen = function(event) {
            console.log('SSE connection opened');
        };
        
        evtSource.onerror = function(event) {
            console.log('SSE connection error:', event);
        };
        
        evtSource.onmessage = function(event) {
            console.log('SSE message received:', event.data);
            if (event.data === "update") {
                // Force immediate update
                fetchPrediction();
                // Reset the interval timer to avoid quick double updates
                clearInterval(updateInterval);
                updateInterval = setInterval(fetchPrediction, 60000);
            }
        };

        // Store interval ID so we can reset it
        let updateInterval = setInterval(fetchPrediction, 60000);

        // Initial update
        fetchPrediction();
    </script>
</body>
</html>

